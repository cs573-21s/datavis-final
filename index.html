<html>

<head>
    <style>
        body {
            font-family: 'Open Sans';
        }

        #streamChart {
            float: left;
            width: 50%;
        }

        #info {
            float: left;
            width: 15%;
        }

        #legend {
            float: right;
            width: 30%;
            margin-top: 20px;
            text-align: center;
        }

        #scatterPlots {
            float: left;
            width: 100%;
        }

        button {
            display: inline-block;
            margin: 2px;
        }
    </style>
</head>

<body>
    <div id="charts">
        <div id="info">
            <h2>Spotify Top Songs</h2>
            <h3>2010-2019</h3>
        </div>
        <div id="streamChart"></div>
        <div id="legend"></div>
        <div id="scatterPlots"></div>
    </div>
</body>

</html>

<link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans" />

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="//alexmacy.github.io/crossfilter/crossfilter.v1.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

<script>
    console.log(d3);
    var buttonClicked = -1;

    // Getting genres for key
    var keys = [];

    // Load data in
    d3.csv('top10s.csv', function (er, data) {
        data.forEach(function (d) {
            d["title"] = d["title"]
            d["artist"] = d["artist"]
            d["genre"] = d["top genre"]
            d["year"] = +d["year"]
            d["bpm"] = +d["bpm"]
            d["nrgy"] = +d["nrgy"]
            d["dnce"] = +d["dnce"]
            d["dB"] = +d["dB"]
            d["live"] = +d["live"]
            d["val"] = +d["val"]
            d["dur"] = +d["dur"]
            d["acous"] = +d["acous"]
            d["spch"] = +d["spch"]
            d["pop"] = +d["pop"]

            if (!keys.includes(d["top genre"])) {
                keys.push(d["top genre"])
            }
        })

        //console.log(data)

        // Crossfilter and organizing data
        var songs = crossfilter(data),
            year = songs.dimension(function (d) { return d.year; }),
            tempo = songs.dimension(function (d) { return d.tempo; }),
            tempoGroup = tempo.group().all();

        var orgData = [],
            i = 0;          // i represents the year

        for (i; i < 10; i++) {
            var filteredYear = year.filterFunction(function (d) { return d == (2010 + i); }),
                tempCrossfilter = crossfilter(filteredYear.top(Infinity)),
                byGenre = tempCrossfilter.dimension(function (d) { return d.genre; }),
                genreGroup = byGenre.group().all();

            var byYear = {},
                j = 0;      // j represents the index of the genre in keys

            byYear.year = 2010 + i;
            for (j; j < keys.length; j++) {
                var curGenre = keys[j],
                    index = genreIndex(curGenre, genreGroup);

                if (index == -1) {  // if genre isn't on year's list
                    byYear[curGenre] = 0;
                } else {
                    byYear[curGenre] = genreGroup[index].value;
                }
                orgData.push(byYear);
            }
        }

        // establishing variables
        var margin = { top: 20, right: 10, bottom: 0, left: 10 },
            width = 800 - margin.left - margin.right,
            height = 400 - margin.left - margin.right;

        // creating svg 
        var svg = d3.select("div#streamChart").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.left + margin.right)
            .attr("transform", "translate(" + margin.left + ", " + margin.top + ")");

        // scaling
        var xscale = d3.scaleLinear()
            .domain(d3.extent(data, function (d) { return d.year; }))
            .range([0, width]);

        var yscale = d3.scaleLinear()
            .domain([-50, 50])
            .range([height, 0]);

        // Add X axis
        var x_axis = d3.axisBottom()
            .scale(xscale)
        svg.append("g")
            .attr("transform", "translate(" + margin.left + "," + height + ")")
            .call(x_axis)
            .attr("class", "xAxis")
            .call(d3.axisBottom(xscale)
                .tickSize(-height)
                .tickValues([2010, 2011, 2012, 2013, 2013, 2014, 2015, 2016, 2017, 2018, 2019]))
            .select(".domain").remove()
        svg.selectAll(".tick line").attr("stroke", "#b8b8b8")

        // Color palette
        var color = d3.scaleOrdinal()
            .domain(keys)
            .range(d3.schemeSet3)

        // Tooltip
        var tooltip = d3.select("div#info").append("p")
            .attr("id", "line0")
            .attr("x", 700)
            .attr("y", 20)
            .style("opacity", 0)
            .style("font-size", 17)


        // Change the tooltip when user hover / move / leave a cell
        var mouseover = function (d) {
            tooltip.style("opacity", 1)
            d3.selectAll(".area")
                .style("opacity", .2)
            d3.select(this)
                .style("stroke", "black")
                .style("opacity", 1)

            d3.selectAll().selectAll("[genre='" + d3.select(this).attr("genre") + "']")
                .attr("r", 4)
                .style("fill", "red")
                .style("opacity", 1)
        }
        var mousemove = function (d, i) {
            grp = keys[i]
            tooltip.text(grp)
        }
        var mouseleave = function (d) {
            tooltip.style("opacity", 0)
            d3.selectAll(".area")
                .style("opacity", 1)
                .style("stroke", "none")
                .style("fill", function (d) { return color(d.key); })
        }

        // Stack data
        var stackedData = d3.stack()
            .offset(d3.stackOffsetSilhouette)
            .keys(keys)
            (orgData)

        // Create streams
        svg.selectAll("layer")
            .data(stackedData)
            .enter()
            .append('path')
            .attr("class", "area")
            .attr("genre", function (d) { return d.key; })
            .style("fill", function (d) { return color(d.key); })
            .attr("color", function (d) { return color(d.key); })
            .attr("d", d3.area()
                .x(function (d) { return xscale(d.data.year); })
                .y0(function (d) { return yscale(d[0]); })
                .y1(function (d) { return yscale(d[1]); }))
            .attr("transform", "translate(" + margin.left + ", 0 )")
            .on("mouseover", mouseover)
            .on("mousemove", mousemove)
            .on("mouseleave", mouseleave)

        scatterplot(data, year, tooltip, "bpm", "tempoPlot")
        scatterplot(data, year, tooltip, "nrgy", "energyPlot")
        scatterplot(data, year, tooltip, "dnce", "dancePlot")
        scatterplot(data, year, tooltip, "dB", "volumePlot")
        scatterplot(data, year, tooltip, "live", "livePlot")
        scatterplot(data, year, tooltip, "val", "valencePlot")
        scatterplot(data, year, tooltip, "dur", "durationPlot")
        scatterplot(data, year, tooltip, "acous", "acousPlot")
        scatterplot(data, year, tooltip, "spch", "speechPlot")

        genreLengend(keys, color)

    })

    function genreIndex(curGenre, genres) {
        var result = -1,
            i = 0;
        for (i; i < genres.length; i++) {
            if (curGenre == genres[i].key) {
                //console.log(curGenre + " is " + d.key)
                result = i;
            }
        }
        return result;
    }

    function scatterplot(data, year, tooltip, prop, id) {

        var margin = { top: 30, right: 30, bottom: 0, left: 20 },
            height = 150 - margin.top - margin.bottom,
            width = 300 - margin.right - margin.left;

        // Tooltip
        var tooltip2 = d3.select("div#info").append("p")
            .attr("id", "line1")
            .attr("x", 700)
            .attr("y", 20)
            .style("opacity", 0)
            .style("font-size", 17)


        // Creating svg 
        var svg = d3.select("div#scatterPlots").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.left + margin.right)
            .attr("transform", "translate(" + margin.left + ", " + margin.top + ")")
            .attr('id', id);

        // Scaling
        var xscale = d3.scaleLinear()
            .domain(d3.extent(data, function (d) { return d.year; }))
            .range([0, width]);

        var yscale = d3.scaleLinear()
            .domain(d3.extent(data, function (d) { return d[prop] }))
            .range([height, 0]);

        // Add X Axis
        var x_axis = d3.axisBottom()
            .scale(xscale)
        svg.append("g")
            .attr("transform", "translate(" + margin.left + "," + height + ")")
            .call(x_axis)
            .attr("class", "xAxis")


        // Add Y Axis
        var y_axis = d3.axisLeft()
            .scale(yscale)
        svg.append("g")
            .attr("transform", "translate(" + margin.left + ", 0 )")
            .call(y_axis)
            .attr("class", "yAxis")
        svg.append("text")
            .attr("text-anchor", "middle")
            .attr("y", -60)
            .attr("x", -(height / 2))
            .attr("dy", ".75em")
            .attr("transform", "rotate(-90)")
            .text(prop);

        // Change circle when user hovers / leaves circle
        var mouseover = function (d, i) {
            if (buttonClicked == -1) {
                d3.selectAll("circle.pt" + i)
                    .raise()
                    .transition()
                    .duration(100)
                    .attr("r", 4)
                    .style("fill", "red")
                    .style("opacity", 1)
                    .style("stroke", "black")
            } else if (d3.select(this).style("r") == 4) {
                var song = d.title + " by " + d.artist,
                    gen = "Genre: " + d.genre
                tooltip.text(song)
                tooltip.style("opacity", 1)
                tooltip2.text(gen)
                tooltip2.style("opacity", 1)
            }

        }

        var mouseleave = function (d) {
            if (buttonClicked == -1) {
                d3.selectAll("circle")
                    .transition()
                    .duration(100)
                    .attr("r", 2)
                    .style("fill", "black")
                    .style("stroke", "none")
                    .style("opacity", 0.25)
            }
            tooltip.style("opacity", 0)
            tooltip2.style("opacity", 0)
        }

        //Add circles
        var circles = svg.selectAll("circle")
            .data(data)
            .enter()
            .append("circle")
            .attr("genre", function (d) { return d.genre; })
            .attr("class", function (d, i) { return "pt" + i; })
            .attr("cx", function (d) { return xscale(d.year); })
            .attr("cy", function (d) { return yscale(d[prop]); })
            .attr("r", 2)
            .style("opacity", "0.25")
            .attr("transform", "translate(" + margin.left + ", 0 )")
            .on("mouseover", mouseover)
            .on("mouseleave", mouseleave)

        // Getting averages for line
        var average = [],
            i = 0;

        for (i; i < 10; i++) {
            var filteredYear = year.filterFunction(function (d) { return d == (2010 + i); }),
                tempCrossfilter = crossfilter(filteredYear.top(Infinity)),
                propertyDim = tempCrossfilter.dimension(function (d) { return d[prop]; }),
                propertyGroup = propertyDim.group().all();

            var j = 0,
                sum = 0,
                count = 0;

            for (j; j < propertyGroup.length; j++) {
                sum += propertyGroup[j].value * propertyGroup[j].key
                count += propertyGroup[j].value
            }
            average.push({ "year": 2010 + i, "avg": sum / count })
        }

        // Line generator
        var avgLine = d3.line()
            .x(function (d) { return xscale(d.year); })
            .y(function (d) { return yscale(d.avg); })

        // Add line
        var line = svg.selectAll(".line")
            .data([average])
            .enter()
            .append("path")
            .attr("fill", "none")
            .attr("stroke", "steelblue")
            .attr("stroke-width", 1)
            .attr("d", avgLine)
            .attr("transform", "translate(" + margin.left + ", 0 )")

    }

    function genreLengend(keys, color) {

        // Establish variables
        var margin = { top: 30, right: 30, bottom: 0, left: 20 },
            height = 150 - margin.top - margin.bottom,
            width = 250 - margin.right - margin.left;

        // Select div
        var list = d3.select("div#legend")

        // Create reset button
        list.append("button")
            .text("Reset")
            .attr("margin", "")
            .on("click", function (d) {
                buttonClicked = -1;
                d3.selectAll(".legendButton")
                    .transition()
                    .duration(500)
                    .style("opacity", 1)
                d3.selectAll(".area")
                    .transition()
                    .duration(500)
                    .style("opacity", 1)
                    .style("fill", function (d) { return color(d.key); })
                    .style("stroke", "none")
                    .attr("pointer-events", "all")
                d3.selectAll("circle")
                    .transition()
                    .duration(500)
                    .style("r", 2)
                    .style("fill", "black")
                    .style("opacity", 0.25)
                    .attr("pointer-events", "all")
            })
        list.append("br")

        // Create Buttons
        var buttons = list.selectAll(".button")
            .data(keys)
            .enter()
            .append('button')
            .attr("id", function (d, i) { return "button" + i; })
            .attr("class", "legendButton")
            .text(function (d) { return d; })
            .attr("width", "auto")
            .style("background-color", function (i) { return color(i); })
            .on("click", function (d) {
                buttonClicked = 1
                d3.selectAll(".legendButton")
                    .transition()
                    .duration(500)
                    .style("font-weight", "normal")

                d3.selectAll(".area")
                    .transition()
                    .duration(500)
                    .style("opacity", 0.2)
                    .style("fill", function (d) { return color(d.key); })
                    .style("stroke", "none")
                    .attr("pointer-events", "none")

                d3.selectAll("circle")
                    .transition()
                    .duration(500)
                    .style("r", 2)
                    .style("fill", "black")
                    .style("opacity", 0.25)
                //.attr("pointer-events", "none")

                d3.select(this)
                    .transition()
                    .duration(500)
                    .style("font-weight", "bold")

                d3.selectAll("[genre='" + d + "']")
                    .raise()
                    .transition()
                    .duration(500)
                    .style("opacity", 1)
                    .style("stroke", "black")
                    .style("fill", "red")
                    .style("r", 4)
            })
    }

</script>